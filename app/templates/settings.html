{% extends "base.html" %} {% block body %}
<title>Settings - Perimeter</title>
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='settings-styles.css') }}"
/>

<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-header">
    <svg
      class="logo-icon"
      width="32"
      height="32"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    >
      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
    </svg>
    <span class="brand-name">Perimeter</span>
  </div>

  <nav class="sidebar-nav">
    <a href="{{ url_for('main.dashboard') }}" class="nav-item">
      <svg
        class="nav-icon"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <rect x="3" y="3" width="7" height="7"></rect>
        <rect x="14" y="3" width="7" height="7"></rect>
        <rect x="14" y="14" width="7" height="7"></rect>
        <rect x="3" y="14" width="7" height="7"></rect>
      </svg>
      <span>Dashboard</span>
    </a>
    <a href="{{ url_for('main.quick_scan') }}" class="nav-item">
      <svg
        class="nav-icon"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <span>Quick Scan</span>
    </a>
    <a href="{{ url_for('main.batch_scan') }}" class="nav-item">
      <svg
        class="nav-icon"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 0 1 0 3.75H5.625a1.875 1.875 0 0 1 0-3.75Z"
        />
      </svg>
      <span>Batch Scan</span>
    </a>
    <a href="{{ url_for('main.report') }}" class="nav-item">
      <svg
        class="nav-icon"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
        ></path>
        <polyline points="14 2 14 8 20 8"></polyline>
      </svg>
      <span>Scan History</span>
    </a>
    <a href="{{ url_for('main.settings') }}" class="nav-item active">
      <svg
        class="nav-icon"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path
          d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"
        ></path>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
      <span>Settings</span>
    </a>
    {% if is_admin %}
    <a href="{{ url_for('admin.dashboard') }}" class="nav-item admin-link">
      <svg
        class="nav-icon"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
      </svg>
      <span>Admin Panel</span>
    </a>
    {% endif %}
  </nav>

  <div class="sidebar-footer">
    <a href="{{ url_for('main.logout') }}" class="nav-item">
      <svg
        class="nav-icon"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
      <span>Logout</span>
    </a>
  </div>
</div>

<!-- Main Content -->
<div class="main-content">
  <!-- Header -->
  <header class="settings-header">
    <div>
      <h1 class="page-title">Settings</h1>
      <p class="page-subtitle">
        Manage your account and application preferences
      </p>
    </div>
  </header>

  <!-- Settings Content -->
  <div class="settings-container">
    <div class="settings-grid">
      <!-- Left Column -->
      <div class="settings-column">
        <!-- Account Settings -->
        <div class="settings-section">
          <div class="section-header">
            <h2 class="section-title">Account Information</h2>
          </div>
          <div class="settings-card">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Username</label>
                <input
                  type="text"
                  class="form-input"
                  value="{{ username }}"
                  readonly
                />
              </div>
              <div class="form-group">
                <label class="form-label">Email Address</label>
                <input
                  type="email"
                  class="form-input"
                  id="emailInput"
                  value="{{ email }}"
                  readonly
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Full Name</label>
              <input
                type="text"
                class="form-input"
                id="fullNameInput"
                value="{{ full_name or '' }}"
                readonly
              />
            </div>
          </div>
        </div>

        <!-- Password Settings -->
        <div class="settings-section">
          <div class="section-header">
            <h2 class="section-title">Change Password</h2>
          </div>
          <div class="settings-card">
            <div class="form-group">
              <label class="form-label">Current Password</label>
              <input
                type="password"
                class="form-input"
                id="currentPassword"
                placeholder="Enter current password"
              />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">New Password</label>
                <input
                  type="password"
                  class="form-input"
                  id="newPassword"
                  placeholder="New password"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Confirm Password</label>
                <input
                  type="password"
                  class="form-input"
                  id="confirmPassword"
                  placeholder="Confirm password"
                />
              </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
              <button class="btn-primary btn-sm" id="changePasswordBtn">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect
                    x="3"
                    y="11"
                    width="18"
                    height="11"
                    rx="2"
                    ry="2"
                  ></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                Update Password
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="settings-column">
        <!-- Appearance Settings -->
        <div class="settings-section">
          <div class="section-header">
            <h2 class="section-title">Appearance</h2>
          </div>
          <div class="settings-card scan-appearance-card">
            <div class="form-group">
              <label class="form-label">Theme</label>
              <div class="theme-options" id="themeOptions">
                <label class="theme-option" data-theme="dark">
                  <input type="radio" name="theme" value="dark" />
                  <div class="theme-preview dark-theme">
                    <div class="theme-preview-content">
                      <div class="theme-bar"></div>
                      <div class="theme-bar"></div>
                    </div>
                  </div>
                  <span class="theme-name">Dark</span>
                </label>
                <label class="theme-option" data-theme="light">
                  <input type="radio" name="theme" value="light" />
                  <div class="theme-preview light-theme">
                    <div class="theme-preview-content">
                      <div class="theme-bar"></div>
                      <div class="theme-bar"></div>
                    </div>
                  </div>
                  <span class="theme-name">Light</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Danger Zone - Full Width -->
    <div class="settings-section danger-section">
      <!-- <div class="section-header">
                <h2 class="section-title">Danger Zone</h2>
            </div>
            <div class="settings-card danger-card">
                <div class="danger-row">
                    <div class="danger-item">
                        <div class="danger-info">
                            <h3 class="danger-title">Delete All Scan History</h3>
                            <p class="danger-description">Remove all scan reports</p>
                        </div>
                        <button class="btn-danger" id="deleteHistoryBtn">Delete History</button>
                    </div>
                </div>
            </div> -->

      <div class="d-flex justify-content-end">
        <button class="btn-secondary" id="saveSettingsBtn">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
            ></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  (function () {
    "use strict";

    // ============================================
    // Theme Management
    // ============================================
    const ThemeManager = {
      STORAGE_KEY: "theme",
      DEFAULT_THEME: "dark",

      init() {
        this.initializeThemeUI();
        this.bindThemeEvents();
      },

      getCurrentTheme() {
        return localStorage.getItem(this.STORAGE_KEY) || this.DEFAULT_THEME;
      },

      applyTheme(theme) {
        // Save to localStorage
        localStorage.setItem(this.STORAGE_KEY, theme);
        // Apply to document (this makes the theme change visible immediately)
        document.documentElement.setAttribute("data-theme", theme);
      },

      initializeThemeUI() {
        const currentTheme = this.getCurrentTheme();

        document.querySelectorAll(".theme-option").forEach((option) => {
          const radio = option.querySelector('input[type="radio"]');
          const isCurrentTheme = radio.value === currentTheme;

          option.classList.toggle("active", isCurrentTheme);
          radio.checked = isCurrentTheme;
        });
      },

      bindThemeEvents() {
        document.querySelectorAll(".theme-option").forEach((option) => {
          option.addEventListener("click", (e) => {
            e.preventDefault();

            // Remove active class from all options
            document.querySelectorAll(".theme-option").forEach((opt) => {
              opt.classList.remove("active");
            });

            // Add active class to clicked option
            option.classList.add("active");

            // Get theme value and apply
            const radio = option.querySelector('input[type="radio"]');
            radio.checked = true;
            const theme = radio.value;

            this.applyTheme(theme);

            // Show notification
            this.showNotification(`Theme changed to ${theme} mode`, "success");
          });
        });
      },

      showNotification(message, type = "success") {
        if (typeof toastr !== "undefined") {
          toastr[type](message);
        } else {
          console.log(`[${type.toUpperCase()}] ${message}`);
        }
      },
    };

    // ============================================
    // Settings Management
    // ============================================
    const SettingsManager = {
      init() {
        this.bindSaveSettings();
        this.bindPasswordChange();
        this.bindDangerZone();
      },

      bindSaveSettings() {
        const saveBtn = document.getElementById("saveSettingsBtn");
        if (!saveBtn) return;

        saveBtn.addEventListener("click", () => {
          const settings = {
            email: document.getElementById("emailInput")?.value || "",
            fullName: document.getElementById("fullNameInput")?.value || "",
          };

          // TODO: Implement API call to save settings
          console.log("Saving settings:", settings);

          ThemeManager.showNotification(
            "Settings saved successfully!",
            "success",
          );
        });
      },

      bindPasswordChange() {
        const changeBtn = document.getElementById("changePasswordBtn");
        if (!changeBtn) return;

        changeBtn.addEventListener("click", () => {
          const currentPassword =
            document.getElementById("currentPassword")?.value;
          const newPassword = document.getElementById("newPassword")?.value;
          const confirmPassword =
            document.getElementById("confirmPassword")?.value;

          // Validation
          if (!currentPassword || !newPassword || !confirmPassword) {
            ThemeManager.showNotification(
              "Please fill in all password fields",
              "error",
            );
            return;
          }

          if (newPassword !== confirmPassword) {
            ThemeManager.showNotification(
              "New passwords do not match",
              "error",
            );
            return;
          }

          if (newPassword.length < 8) {
            ThemeManager.showNotification(
              "Password must be at least 8 characters long",
              "error",
            );
            return;
          }

          // TODO: Implement API call to change password
          console.log("Changing password");
          ThemeManager.showNotification(
            "Password changed successfully!",
            "success",
          );

          // Clear password fields
          document.getElementById("currentPassword").value = "";
          document.getElementById("newPassword").value = "";
          document.getElementById("confirmPassword").value = "";
        });
      },

      bindDangerZone() {
        const deleteHistoryBtn = document.getElementById("deleteHistoryBtn");
        if (!deleteHistoryBtn) return;

        deleteHistoryBtn.addEventListener("click", () => {
          if (
            confirm(
              "Are you sure you want to delete all scan history? This action cannot be undone.",
            )
          ) {
            // TODO: Implement API call to delete history
            console.log("Deleting scan history");
            ThemeManager.showNotification(
              "Scan history deleted successfully!",
              "success",
            );
          }
        });
      },
    };

    // ============================================
    // Initialize on DOM Ready
    // ============================================
    document.addEventListener("DOMContentLoaded", () => {
      ThemeManager.init();
      SettingsManager.init();
    });

    // Also run immediately for cases where DOMContentLoaded already fired
    if (document.readyState !== "loading") {
      ThemeManager.init();
      SettingsManager.init();
    }
  })();
</script>

{% endblock %}
